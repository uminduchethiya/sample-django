name: Django CI & FTP Deploy - sampleauthapp
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.12]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Django Tests
        run: python manage.py test
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      # Clean up files that shouldn't be deployed
      - name: Clean deployment files
        run: |
          find . -name "__pycache__" -type d -exec rm -rf {} + || true
          find . -name "*.pyc" -delete || true
          rm -rf .git .github venv || true
      
      # Option 1: Use sebastianpopp/ftp-action (more reliable for shared hosting)
      - name: FTP Deploy Alternative
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: "."
          remoteDir: "."
          
      # Option 2: Use raw FTP commands (uncomment if above doesn't work)
      # - name: Install lftp
      #   run: sudo apt-get update && sudo apt-get install -y lftp
      # - name: Deploy via lftp
      #   run: |
      #     lftp -c "
      #       open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
      #       set ftp:passive-mode true;
      #       set net:timeout 30;
      #       set net:max-retries 3;
      #       mirror -R --delete --parallel=3 --exclude='.git' --exclude='__pycache__' . ./;
      #       bye
      #     "
